//
//  AprendeView.swift
//  Asira
//
//  Created by Mario Moreno on 5/13/25.
//

//
//  InicioView.swift
//  AppHack
//
//  Created by Dilhan Mora on 12/05/25.
//

import SwiftUI

public struct AprendeView: View {
    
    @Namespace private var namespace
    @State private var showDetail: Bool = false
    @State private var currentData: ListData? = nil
    
    @State private var  datas = [ListData]()
    
    public init() {}
    public var body: some View {
        ZStack {
            List(datas) { data in
                ListRow(namespace: namespace, data: data)
#if os(iOS)
                    .listRowSeparator(.hidden)
#endif
                    .listRowBackground(Color.clear)
                    .padding(.vertical, 8)
                    .shadow(color: Color.black.opacity(0.2), radius: 5, x: 0, y: 6)
                    .onTapGesture {
                        DispatchQueue.main.async {
                            withAnimation(.transitionSpring) {
                                currentData = data
                                showDetail = true
                            }
                        }
                    }
            }
            .listStyle(.plain)
            .opacity(showDetail ? 0.0 : 1.0)
            if showDetail {
                if let data = currentData {
                    DetailView(namespace: namespace, data: data, show: $showDetail)
                }
            }
        }
        .animation(.transitionSpring, value: showDetail)
        .onAppear {
            DispatchQueue.main.async {
                datas = [
                    ListData(
                        title: "üå± Siembra",
                        name: "Inicio de ciclo",
                        description: "Aprende cu√°ndo y c√≥mo sembrar.",
                        imageName: "siembra",
                        detalle: "La siembra es el punto de partida del ciclo agr√≠cola. En las comunidades rurales mexicanas, este proceso suele hacerse de forma manual usando herramientas como el bast√≥n sembrador o la coa. Antes de sembrar, el productor limpia y prepara el terreno, eliminando restos del cultivo anterior, maleza y piedras. A veces se utiliza el arado animal o mec√°nico si se cuenta con los recursos.La siembra puede hacerse a golpe (abriendo un hoyo con el bast√≥n y dejando caer la semilla) o por surcos. En algunos casos, se mezcla la semilla con ceniza, ajo o chile molido para evitar que la coman los insectos. La √©poca de siembra depende mucho del tipo de cultivo y del inicio de la temporada de lluvias.Sembrar demasiado temprano puede hacer que la semilla se seque antes de germinar, y demasiado tarde reduce el tiempo de crecimiento. Es importante respetar la profundidad y el espaciamiento correcto para asegurar que cada planta tenga suficiente luz, agua y nutrientes. Muchas decisiones durante esta etapa se toman por experiencia heredada, aunque una gu√≠a t√©cnica puede mejorar notablemente los resultados."
                    ),
                    ListData(
                        title: "üíß Riego",
                        name: "Uso del agua",
                        description: "Evita el desperdicio en tu parcela.",
                        imageName: "riego",
                        detalle: "El riego es una pr√°ctica cr√≠tica para el √©xito del cultivo, especialmente en regiones donde las lluvias son escasas o irregulares. La mayor√≠a de peque√±os productores en M√©xico dependen del temporal, pero cuando tienen acceso a agua, utilizan riego por gravedad, canales o simplemente cubetas.Estos m√©todos tradicionales suelen desperdiciar mucha agua. M√©todos m√°s eficientes como el riego por goteo o microaspersi√≥n reducen el consumo, pero requieren inversi√≥n y capacitaci√≥n. Existen versiones econ√≥micas que pueden hacerse con mangueras perforadas y garrafones colocados en alto para generar presi√≥n por gravedad.Tambi√©n se puede conservar la humedad del suelo aplicando mulching (acolchado), es decir, cubriendo la base de las plantas con paja, hojas secas o pl√°stico negro. Esto reduce la evaporaci√≥n y mejora la temperatura del suelo. Capacitar al agricultor sobre el manejo del riego puede marcar una gran diferencia, ya que regar de m√°s tambi√©n es da√±ino: puede pudrir las ra√≠ces o favorecer plagas."
                    ),
                    ListData(
                        title: "üåø Mantenimiento",
                        name: "Cuidados del cultivo",
                        description: "Deshierba y fertiliza bien.",
                        imageName: "deshierbe",
                        detalle: "Despu√©s de la siembra, el cultivo necesita atenci√≥n constante. El deshierbe es una pr√°ctica fundamental que consiste en quitar la maleza que compite con el cultivo por agua, luz y nutrientes. Se realiza con machete, azad√≥n o a mano, dependiendo del tipo de cultivo.La fertilizaci√≥n tambi√©n es esencial. Algunos agricultores utilizan abonos org√°nicos como esti√©rcol, compost o bocashi, mientras que otros usan fertilizantes qu√≠micos. Sin asesor√≠a, la dosificaci√≥n puede ser incorrecta. Adem√°s, algunas pr√°cticas como el aporque (juntar tierra en la base de la planta) ayudan a fortalecer el tallo y proteger las ra√≠ces.El monitoreo constante permite detectar problemas temprano, como plantas amarillas, presencia de plagas o deficiencias de nutrientes. Muchas veces el conocimiento de estas pr√°cticas se transmite oralmente, lo que puede limitar el acceso a nuevas t√©cnicas. Un apoyo visual o tutorial puede marcar la diferencia."
                    ),
                    ListData(
                        title: "üêõ Plagas",
                        name: "Protecci√≥n",
                        description: "Identifica y controla plagas comunes.",
                        imageName: "plagas",
                        detalle: "Las plagas son uno de los mayores enemigos del productor. Gusano cogollero, pulgones, trips, hongos y bacterias son comunes en muchas regiones. Detectarlas a tiempo es crucial, pero muchos agricultores no saben identificar sus s√≠ntomas o no tienen acceso a productos para tratarlas.Existen m√©todos tradicionales efectivos: trampas de feromonas, repelentes hechos con ajo, chile, cebolla, jab√≥n pot√°sico o infusiones de plantas. Sin embargo, su efectividad depende del momento de aplicaci√≥n. Tambi√©n es importante la rotaci√≥n de cultivos y el uso de plantas repelentes como la cal√©ndula o la albahaca.Un gran problema es la automedicaci√≥n del cultivo: se aplican productos vencidos, mal diluidos o en dosis equivocadas, lo cual da√±a el ambiente y la salud. Educar sobre el manejo integrado de plagas (MIP) puede reducir costos y riesgos."
                    ),
                    ListData(
                        title: "üåΩ Cosecha",
                        name: "Recolecci√≥n",
                        description: "Elige el momento correcto para cosechar.",
                        imageName: "cosecha",
                        detalle: "La cosecha se realiza cuando el fruto, grano o hortaliza ha alcanzado su punto √≥ptimo de maduraci√≥n. En ma√≠z, por ejemplo, se espera a que las hojas y mazorcas est√©n secas. En frijol, cuando las vainas est√°n crujientes. Una cosecha prematura puede reducir el rendimiento y una tard√≠a aumenta el riesgo de enfermedades o p√©rdidas por lluvia.Se realiza manualmente en la mayor√≠a de los casos. El trabajo lo hace la familia o vecinos que se ayudan entre s√≠. El transporte hasta la casa o al punto de venta puede ser una barrera importante, sobre todo en comunidades sin acceso vehicular. El uso de costales, animales de carga o carretillas improvisadas es com√∫n.Despu√©s de la cosecha, se realiza una selecci√≥n del grano o producto, descartando el que est√© da√±ado, con hongos o mordido. Este proceso es fundamental para obtener buen precio y evitar problemas en el almacenaje."
                    ),
                    ListData(
                        title: "üè† Almacenaje",
                        name: "Postcosecha",
                        description: "Conserva lo que sembraste.",
                        imageName: "almacenaje",
                        detalle: "Una vez cosechado, el grano debe secarse completamente al sol para evitar que se enmohezca. Luego se almacena en costales, tambos, trojes o bolsas selladas. Muchas familias guardan su cosecha en la cocina, el patio o una bodega improvisada.Para evitar plagas como el gorgojo, se usan pr√°cticas como mezclar el grano con ceniza, chile seco, ajo o usar hojas de aguacate. Tambi√©n existen bolsas herm√©ticas y silos met√°licos familiares que conservan el grano por varios meses sin necesidad de qu√≠micos.La humedad es el principal enemigo: un grano mal seco se fermenta y se pierde. Adem√°s, la mala ventilaci√≥n favorece la aparici√≥n de hongos. Capacitar al productor sobre t√©cnicas de secado, manejo postcosecha y conservaci√≥n natural puede ayudarle a conservar mejor su esfuerzo."
                    ),
                    ListData(
                        title: "üõí Venta",
                        name: "Comercializaci√≥n",
                        description: "Vende sin intermediarios.",
                        imageName: "venta",
                        detalle: "Vender la cosecha es uno de los momentos m√°s dif√≠ciles para el peque√±o agricultor. Muchos venden a intermediarios que llegan directo al campo, pagan en efectivo pero a precios bajos. No hay contrato, garant√≠a ni certeza del pago justo. Otros llevan su producto al mercado local o a la plaza, donde deben competir con revendedores.La mayor√≠a desconoce el precio real del producto en otras ciudades, no sabe calcular su costo de producci√≥n, ni c√≥mo empacar o presentar su producto para que sea m√°s atractivo. Algunos ni siquiera tienen transporte para llevarlo a vender.Existen programas como el de ‚ÄúPeque√±o Productor Cuentas Conmigo‚Äù de Walmart que buscan dar acceso directo al mercado, pero requieren cumplir ciertos est√°ndares. Una herramienta que conecte directamente al productor con compradores, que ense√±e a calcular su ganancia y evitar p√©rdidas, puede ser un cambio enorme en su econom√≠a familiar."
                    )
                ]
            }
        }
    }
}

fileprivate
extension Animation {
    static var transitionSpring: Animation {
       self.spring(response: 0.48, dampingFraction: 0.82, blendDuration: 0.7)
    }
}

fileprivate
struct ListData: Identifiable {
    var id = UUID()
    var title: String
    var name: String
    var description: String
    var imageName: String
    var detalle: String // ‚Üê esto es lo nuevo
}

fileprivate
struct ListRow: View {
    
    let namespace: Namespace.ID
    let data: ListData
    
    var body: some View {
        NamespaceView(namespace: namespace, data: data)
            .frame(height: 280)
            .clipShape(RoundedRectangle(cornerRadius: 20, style: .continuous))
        
        
    }
}

fileprivate
struct DetailView: View {
    
    let namespace: Namespace.ID
    let data: ListData
    @Binding var show: Bool
    @State private var showText: Bool = false
    
    var body: some View {
        ZStack(alignment: .topTrailing) {
            ScrollView {
                VStack {
                    NamespaceView(namespace: namespace, data: data)
                        .frame(height: 460)
                    
                    ZStack {
                        if showText {
                            Text(data.detalle)
                                .lineLimit(nil)
                                .padding(12)
                                .transition(.move(edge: .bottom).combined(with: .opacity))
                        }
                    }
                    .animation(.transitionSpring, value: showText)
                    .opacity(0.5)
                    .onAppear {
                        DispatchQueue.main.async {
                            withAnimation(.easeInOut) {
                                showText = true
                            }
                        }
                    }
                }
            }
            Image(systemName: "xmark")
                .padding(8)
                .background(Color.white)
                .foregroundColor(Color.black)
                .clipShape(Circle())
                .shadow(color: Color.black.opacity(0.16), radius: 3, x: 0, y: 0)
                .padding()
                .onTapGesture {
                    withAnimation(.transitionSpring) {
                        show = false
                    }
                }
        }
    }
}

fileprivate
struct NamespaceView: View {
    
    
    
    let namespace: Namespace.ID
    let data: ListData
    
    func iconFor(_ title: String) -> String {
        if title.contains("Siembra") { return "leaf.circle.fill" }
        if title.contains("Riego") { return "drop.circle.fill" }
        if title.contains("Deshierbe") || title.contains("Mantenimiento") { return "scissors" }
        if title.contains("Plagas") { return "ant.circle.fill" }
        if title.contains("Cosecha") { return "basket.fill" }
        if title.contains("Almacenaje") { return "archivebox.fill" }
        if title.contains("Venta") { return "cart.fill" }
        return "square.grid.2x2" // √≠cono por defecto
    }
    
    var imageTitleView: some View {
        ZStack(alignment: .bottomLeading) {
            GeometryReader { proxy in
                ZStack {
                    Image(data.imageName)
                        .resizable()
                        .scaledToFill()
                }
            }
            .clipShape(Rectangle())
            .matchedGeometryEffect(id: "image\(data.id)", in: namespace)
            
            VStack(alignment: .leading, spacing: -6) {
                let arrText = data.title.split(separator: "\n")
                ForEach(arrText, id: \.self) { text in
                    Text(text)
                        .font(.title)
                        .fontWeight(.black)
                        .foregroundColor(Color.white)
                }
            }
            .shadow(color: Color.black.opacity(0.16), radius: 3, x: 0, y: 0)
            .padding()
            .padding(.bottom, 56)
            .matchedGeometryEffect(id: "title\(data.id)", in: namespace)
        }
    }
    
    var bottomInfoView: some View {
        ZStack(alignment: .leading) {
            if #available(macOS 12.0, *) {
                Rectangle()
                    .fill(.thinMaterial)
            } else {
                Rectangle()
                    .fill(Color.black.opacity(0.5))
            }
            HStack(spacing: 0) {
                Image(systemName: iconFor(data.title))
                    .resizable()
                    .scaledToFit()
                    .frame(width: 30, height: 30)
                    .padding(6)
                VStack(alignment: .leading) {
                    Text(data.name)
                        .bold()
                    Text(data.description)
                        .font(.caption)
                        .opacity(0.8)
                }.offset(y: -2)
                Spacer()
                Capsule()
                    .fill(Color(#colorLiteral(red: 0.033477135, green: 0.5796292424, blue: 0.4401996732, alpha: 1)))
                    .overlay(
                        Text("ver")
                            .font(.subheadline)
                            .fontWeight(.bold)
                            .foregroundColor(Color.white)
                    )
                    .frame(width: 70, height: 28)
                    .padding(.trailing)
            }
            .padding(.leading, 6)
        }
        .frame(maxHeight: 61)
        .matchedGeometryEffect(id: "botttom\(data.id)", in: namespace)
    }
    
    var body: some View {
        ZStack(alignment: .bottom) {
            imageTitleView
            bottomInfoView
        }
    }
}

#Preview {
    AprendeView()
}
